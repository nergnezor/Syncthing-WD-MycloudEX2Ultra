name: Build Syncthing for WD MyCloud OS 5

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout wdpksrc
        uses: actions/checkout@v4
        with:
          repository: WDCommunity/wdpksrc
          path: wdpksrc

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxml2 \
            imagemagick \
            docker.io \
            jq
          sudo sed -i 's/default = default_sect/default = default_sect\nlegacy = legacy_sect/g' /etc/ssl/openssl.cnf
          sudo sed -i 's/\[default_sect\]/\[default_sect\]\nactivate = 1\n\[legacy_sect\]\nactivate = 1/g' /etc/ssl/openssl.cnf

      - name: Build Docker image for wdpksrc
        working-directory: wdpksrc
        run: |
          docker build -t wdpk .

      - name: Download latest Syncthing and inject into recipe
        working-directory: wdpksrc
        run: |
          RELEASE_JSON=$(curl -s https://api.github.com/repos/syncthing/syncthing/releases/latest)
          VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name | sed 's/^v//')
          URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("linux-arm")) | select(.name | endswith(".tar.gz")) | .browser_download_url' | head -n 1)

          mkdir -p wdpk/syncthing/src
          curl -L -o syncthing.tar.gz "$URL"
          tar -xzf syncthing.tar.gz --strip-components=1 -C wdpk/syncthing/src/
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Syncthing package for EX2 Ultra
        working-directory: wdpksrc
        env:
          WD_MODEL: MyCloudEX2Ultra
        run: |
          docker run --rm -v "$PWD":/wdpksrc wdpk /bin/bash -c "
            cd /wdpksrc/wdpk/syncthing && \
            sed -i \"s/^Addon_Model:.*/Addon_Model:      ${WD_MODEL}/\" apkg.rc && \
            sed -i 's/mksapkg/mksapkg-OS5/g' build.sh || true && \
            sed -i 's/mksapkg-OS5 /mksapkg-OS5 -E -s -m ${WD_MODEL} /' build.sh || true && \
            ./build.sh
          "

      - name: Collect built package
        working-directory: wdpksrc
        run: |
          mkdir -p out
          find packages -name 'syncthing*.bin' -exec cp {} out/install_me_EX2Ultra.bin \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Syncthing-Package-EX2Ultra
          path: wdpksrc/out/install_me_EX2Ultra.bin
