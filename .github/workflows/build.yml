name: Build Syncthing for WD MyCloud OS 5

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout wdpksrc
        uses: actions/checkout@v4
        with:
          repository: WDCommunity/wdpksrc
          path: wdpksrc

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2 imagemagick jq

      - name: Download latest Syncthing
        run: |
          RELEASE_JSON=$(curl -s https://api.github.com/repos/syncthing/syncthing/releases/latest)
          VERSION=$(echo "$RELEASE_JSON" | jq -r .tag_name | sed 's/^v//')
          URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | contains("linux-arm")) | select(.name | endswith(".tar.gz")) | .browser_download_url' | head -n 1)
          
          mkdir -p wdpksrc/wdpk/syncthing/src
          curl -L -o syncthing.tar.gz "$URL"
          tar -xzf syncthing.tar.gz --strip-components=1 -C wdpksrc/wdpk/syncthing/src/
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Prepare Syncthing OS5 package for EX2 Ultra
        run: |
          cd wdpksrc/wdpk/syncthing
          
          # Update version and model
          sed -i "s/^Version:.*/Version:          ${VERSION:-1.27.1}/" apkg.rc
          sed -i "s/^Addon_Model:.*/Addon_Model:      MyCloudEX2Ultra/" apkg.rc
          
          # Copy mksapkg-OS5 and make executable
          cp ../../mksapkg-OS5 ./
          chmod +x mksapkg-OS5 build.sh

      - name: Build package manually (bypass build.sh issues)
        working-directory: wdpksrc/wdpk/syncthing
        run: |
          # Run the actual packaging command directly
          ./mksapkg-OS5 -E -s -m MyCloudEX2Ultra
          
          # Verify output
          ls -la *.bin*
          echo "Package metadata:"
          grep -E "(Package|Version|Addon_Model)" apkg.rc

      - name: Collect built package
        working-directory: wdpksrc/wdpk
        run: |
          mv MyCloudEX2Ultra_syncthing*.bin ../../out/install_me_EX2Ultra.bin

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Syncthing-Package-EX2Ultra
          path: wdpksrc/out/install_me_EX2Ultra.bin
