name: Build WDPK (Docker)

on:
  workflow_dispatch:
  push:
    paths:
      - 'wdpksrc/**'
      - '.github/workflows/build-wdpk-docker.yml'

jobs:
  build-mycloudex2ultra:
    name: Build MyCloudEX2Ultra (OS5)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build in Debian bookworm container
        shell: bash
        run: |
          set -euo pipefail

          # Build only for MyCloudEX2Ultra using mksapkg-OS5 inside Debian bookworm
          docker run --rm \
            -v "${GITHUB_WORKSPACE}":/work -w /work \
            debian:bookworm \
            bash -lc "\
              set -euo pipefail; \
              apt-get update; \
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                ca-certificates curl git file xz-utils zip unzip make gcc g++ libc6-dev \
                pkg-config autoconf automake libtool; \
              chmod +x wdpksrc/wdpk/syncthing/build.sh; \
              wdpksrc/wdpk/syncthing/build.sh mksapkg-OS5 MyCloudEX2Ultra; \
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyCloudEX2Ultra_syncthing
          path: MyCloudEX2Ultra_syncthing*.bin
          if-no-files-found: error
