name: Build WDPK (Docker)

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-wdpk-docker.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout wdpksrc
        uses: actions/checkout@v4
        with:
          repository: WDCommunity/wdpksrc
          path: wdpksrc

      - name: Build Syncthing for MyCloudEX2Ultra (Debian bookworm)
        run: |
          set -euo pipefail
          docker run --rm \
            -v "${GITHUB_WORKSPACE}/wdpksrc:/work" \
            -w /work \
            debian:bookworm \
            bash -lc '
              set -euo pipefail
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y --no-install-recommends \
                ca-certificates curl git make gcc g++ \
                python3 python3-distutils \
                xz-utils unzip zip file \
                autoconf automake libtool pkg-config \
                gosu \
                wget
              rm -rf /var/lib/apt/lists/*

              # wdpksrc build expects to run from repo root
              # Build the Syncthing package for MyCloudEX2Ultra
              make syncthing EX=EX2Ultra

              # Ensure expected output exists
              test -f out/install_me_EX2Ultra.bin
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: install_me_EX2Ultra.bin
          path: wdpksrc/out/install_me_EX2Ultra.bin
          if-no-files-found: error
