name: create Release

on:
  workflow_dispatch:
  push:

jobs:
   build:
      name: Build
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: Set up QEMU
          uses: docker/setup-qemu-action@v3
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
        - name: Build and export
          uses: docker/build-push-action@v5
          with:
            context: .
            file: ./wd_pk/EX2Ultra/Dockerfile
            push: false
            tags: wd\_pk\_ex2ultra:latest
            outputs: type=local,dest=/tmp/out

        - name: convert
          run: |
            ls -lah /tmp/out
            ls -lah /tmp/out/work
            ls -lah /tmp/out/work/out
            cd /tmp/out/work 
            sudo chmod +x mksapkg-OS5
            sudo chmod +x ./setup/sapkx
            MODEL="EX2Ultra"
            sudo ../../mksapkg-OS5
            # Normalize any MODEL_syncthing*.bin* (including e.g. .bin(DDMMYYYY)) to plain .bin
            find .. -maxdepth 1 -name "${MODEL}_syncthing*.bin*" -print0 | while IFS= read -r -d '' f; do
              sudo mv -v "$f" "${f%.bin*}.bin"
            done
            sudo cp ../${MODEL}_syncthing*.bin /work/out/install_me_EX2Ultra.bin
        
        - uses: actions/upload-artifact@v4
          with:
            name: install_me_EX2Ultra.bin
            path: /tmp/out/work/out/install_me_EX2Ultra.bin
