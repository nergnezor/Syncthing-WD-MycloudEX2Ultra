name: Build WDPK (wdpksrc)

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-wdpk-docker.yml'

permissions:
  contents: read

jobs:
  build-mycloudex2ultra:
    name: Build Syncthing WDPK (MyCloudEX2Ultra)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout WDCommunity/wdpksrc
        uses: actions/checkout@v4
        with:
          repository: WDCommunity/wdpksrc
          path: wdpksrc

      - name: Build in Debian bookworm container
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm \
            -v "${GITHUB_WORKSPACE}/wdpksrc":/work -w /work \
            debian:bookworm \
            bash -lc "\
              set -euo pipefail; \
              apt-get update; \
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                ca-certificates curl git file xz-utils zip unzip make gcc g++ libc6-dev \
                pkg-config autoconf automake libtool; \
              cd wdpk/syncthing; \
              chmod +x build.sh; \
              # build.sh expects to find apkg.rc in the current directory and ../../mksapkg in repo root \
              ln -sf ../../mksapkg-OS5 ../../mksapkg; \
              ./build.sh; \
              # Normalize any .bin(DDMMYYYY) suffixes to plain .bin \
              find ../../packages/syncthing -maxdepth 1 -name "*.bin*" -print0 | while IFS= read -r -d '' f; do mv -v "$f" "${f%.bin*}.bin"; done; \
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyCloudEX2Ultra_syncthing
          path: wdpksrc/packages/syncthing/*MyCloudEX2Ultra*_syncthing_*.bin
          if-no-files-found: error
