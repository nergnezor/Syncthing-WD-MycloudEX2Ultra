name: build-wdpk-docker

on:
  workflow_dispatch:

jobs:
  build-wdpk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image and build WDPK
        run: |
          set -euo pipefail

          # Build docker image
          docker build -t wdpk-builder -f Dockerfile .

          # The build script expects to be run from within the Syncthing WDPK source tree.
          cd wdpksrc/wdpk/syncthing

          # Ensure ../../mksapkg exists by creating a stable symlink expected by the build.
          # (From wdpksrc/wdpk/syncthing, ../../mksapkg resolves to wdpksrc/mksapkg)
          if [ ! -e ../../mksapkg ]; then
            ln -s mksapkg-OS5 ../../mksapkg
          fi

          # Run build
          ./build.sh
