name: Build WDPK (wdpksrc)

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-wdpk-docker.yml'

permissions:
  contents: read

jobs:
  build-mycloudex2ultra:
    name: Build Syncthing WDPK (MyCloudEX2Ultra)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout WDCommunity/wdpksrc
        uses: actions/checkout@v4
        with:
          repository: WDCommunity/wdpksrc
          path: wdpksrc

      - name: Build in Debian bookworm container
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm \
            -v "${GITHUB_WORKSPACE}/wdpksrc":/work -w /work \
            debian:bookworm \
            bash -lc "\
              set -euo pipefail; \
              apt-get update; \
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                ca-certificates curl git file xz-utils zip unzip make gcc g++ libc6-dev \
                pkg-config autoconf automake libtool; \
              chmod +x wdpk/syncthing/build.sh; \
              wdpk/syncthing/build.sh mksapkg-OS5 MyCloudEX2Ultra; \
            "

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyCloudEX2Ultra_syncthing
          path: wdpksrc/MyCloudEX2Ultra_syncthing*.bin
          if-no-files-found: error
